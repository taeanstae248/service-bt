<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>แก้ไขข้อมูลผู้เล่น | BallThai</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/matches.css">
    <link rel="stylesheet" href="/static/css/standing.css">
</head>
<body>
    {{ template "_nav.html" . }}
    <div class="container mt-4">
        <h2>จัดการผู้เล่น</h2>
        <div style="margin-bottom:1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
            <label>ค้นหาชื่อ:
                <input type="text" id="playerNameInput" class="form-control" style="width:180px;" placeholder="ชื่อผู้เล่น">
            </label>
            <label>ค้นหาจากลีก:
                <select id="leagueSelect" class="form-control" style="width:180px;"></select>
            </label>
            <label>ค้นหาจากทีม:
                <select id="teamSelect" class="form-control" style="width:180px;"></select>
            </label>
            <button class="btn btn-primary" onclick="filterPlayers()">ค้นหา</button>
        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ชื่อ</th>
                    <th>หมายเลข</th>
                    <th>ตำแหน่ง</th>
                    <th>ทีม</th>
                    <th>สถานะ</th>
                    <th>จัดการ</th>
                </tr>
            </thead>
            <tbody>
                {{range .Players}}
                <tr 
                    data-id="{{.ID}}"
                    data-name="{{.Name}}"
                    data-shirt_number="{{.ShirtNumber}}"
                    data-position="{{.Position}}"
                    data-matches_played="{{.MatchesPlayed}}"
                    data-goals="{{.Goals}}"
                    data-yellow_cards="{{.YellowCards}}"
                    data-red_cards="{{.RedCards}}"
                    data-status="{{.Status}}"
                >
                    <td>{{.Name}}</td>
                    <td>{{.ShirtNumber}}</td>
                    <td>{{.Position}}</td>
                    <td>{{.TeamName}}</td>
                    <td>{{if eq .Status 0}}Active{{else}}Inactive{{end}}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" onclick="showEditModal(this)">แก้ไข</button>
                    </td>
                </tr>
        <!-- Modal for editing player -->
            <div id="editModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
                <div style="background:#fff; max-width:400px; margin:10vh auto; padding:2rem; border-radius:8px; position:relative;">
                    <h3>แก้ไขข้อมูลผู้เล่น</h3>
                    <form id="editPlayerForm" onsubmit="return savePlayer(event)">
                        <input type="hidden" name="id" id="edit-id">
                        <div style="margin-bottom:1rem;">
                            <label>ชื่อ</label>
                            <input type="text" name="name" id="edit-name" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>หมายเลข</label>
                            <input type="number" name="shirt_number" id="edit-shirt-number" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>ตำแหน่ง</label>
                            <input type="text" name="position" id="edit-position" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>จำนวนนัดที่ลงเล่น</label>
                            <input type="number" name="matches_played" id="edit-matches-played" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>ประตู</label>
                            <input type="number" name="goals" id="edit-goals" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>ใบเหลือง</label>
                            <input type="number" name="yellow_cards" id="edit-yellow-cards" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>ใบแดง</label>
                            <input type="number" name="red_cards" id="edit-red-cards" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>สถานะ</label>
                            <select name="status" id="edit-status" class="form-control">
                                <option value="0">เปิดดึงข้อมูล</option>
                                <option value="1">ปิดดึงข้อมูล</option>
                            </select>
                        </div>
                        <div style="text-align:right;">
                            <button type="button" onclick="closeEditModal()" class="btn btn-secondary">ยกเลิก</button>
                            <button type="submit" class="btn btn-success">บันทึก</button>
                        </div>
                    </form>
                </div>
            </div>
                {{else}}
                <tr><td colspan="6" class="text-center">ไม่พบข้อมูลผู้เล่น</td></tr>
                {{end}}
            </tbody>
        </table>
    </div>
    <script>
        // โหลดลีกและทีม
        let allLeagues = [];
        let allTeams = [];
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/leagues').then(r=>r.json()).then(data => {
                allLeagues = data.data || data.Data || [];
                const leagueSelect = document.getElementById('leagueSelect');
                leagueSelect.innerHTML = '<option value="">-- ทุกลีก --</option>' + allLeagues.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            });
            fetch('/api/teams').then(r=>r.json()).then(data => {
                allTeams = data.data || data.Data || [];
                renderTeamOptions();
            });
            document.getElementById('leagueSelect').addEventListener('change', renderTeamOptions);
        });
        function renderTeamOptions() {
            const leagueId = document.getElementById('leagueSelect').value;
            let teams = allTeams;
            if (leagueId) {
                teams = allTeams.filter(t => t.league_id == leagueId);
            }
            const teamSelect = document.getElementById('teamSelect');
            teamSelect.innerHTML = '<option value="">-- ทุกทีม --</option>' + teams.map(t => `<option value="${t.id}">${t.name_th}</option>`).join('');
        }

        // ฟังก์ชัน filter ตารางผู้เล่น (reload หน้าใหม่ด้วย team_id)
        function filterPlayers() {
            const teamId = document.getElementById('teamSelect').value;
            const playerName = document.getElementById('playerNameInput').value.trim();
            let url = '/players.html';
            const params = [];
            if (teamId) params.push('team_id=' + encodeURIComponent(teamId));
            if (playerName) params.push('name=' + encodeURIComponent(playerName));
            if (params.length > 0) url += '?' + params.join('&');
            window.location.href = url;
        }
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        function showEditModal(btn) {
            // ดึงข้อมูล player จาก data-* ของ <tr>
            var tr = btn.closest('tr');
            document.getElementById('edit-id').value = tr.getAttribute('data-id');
            document.getElementById('edit-name').value = tr.getAttribute('data-name');
            document.getElementById('edit-shirt-number').value = tr.getAttribute('data-shirt_number');
            document.getElementById('edit-position').value = tr.getAttribute('data-position');
            document.getElementById('edit-matches-played').value = tr.getAttribute('data-matches_played');
            document.getElementById('edit-goals').value = tr.getAttribute('data-goals');
            document.getElementById('edit-yellow-cards').value = tr.getAttribute('data-yellow_cards');
            document.getElementById('edit-red-cards').value = tr.getAttribute('data-red_cards');
            document.getElementById('edit-status').value = tr.getAttribute('data-status');
            document.getElementById('editModal').style.display = 'block';
        }
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        function savePlayer(event) {
            event.preventDefault();
            const form = document.getElementById('editPlayerForm');
            const id = document.getElementById('edit-id').value;
            const payload = {
                name: document.getElementById('edit-name').value,
                shirt_number: parseInt(document.getElementById('edit-shirt-number').value),
                position: document.getElementById('edit-position').value,
                matches_played: parseInt(document.getElementById('edit-matches-played').value),
                goals: parseInt(document.getElementById('edit-goals').value),
                yellow_cards: parseInt(document.getElementById('edit-yellow-cards').value),
                red_cards: parseInt(document.getElementById('edit-red-cards').value),
                status: parseInt(document.getElementById('edit-status').value)
            };
            fetch(`/api/players/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (res.ok) {
                    alert('บันทึกสำเร็จ');
                    closeEditModal();
                    location.reload();
                } else {
                    res.text().then(t => alert('เกิดข้อผิดพลาด: ' + t));
                }
            })
            .catch(err => {
                alert('เกิดข้อผิดพลาด: ' + err);
            });
            return false;
        }
    </script>
</body>
</html>
