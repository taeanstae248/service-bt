<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô | BallThai</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/matches.css">
    <link rel="stylesheet" href="/static/css/standing.css">
</head>
<body>
    {{ template "_nav.html" . }}
    <div class="container mt-4">
        <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
        <div style="margin-bottom:1rem; display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
            <button id="scrapePlayerBtn" class="btn btn-primary" onclick="scrapePlayers()">üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button>
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠:
                <input type="text" id="playerNameInput" class="form-control" style="width:180px;" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô">
            </label>
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏•‡∏µ‡∏Å:
                <select id="leagueSelect" class="form-control" style="width:180px;"></select>
            </label>
            <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°:
                <select id="teamSelect" class="form-control" style="width:180px;"></select>
            </label>
            <button class="btn btn-primary" onclick="filterPlayers()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</th>
                    <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                    <th>‡∏ó‡∏µ‡∏°</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody>
                {{range .Players}}
                <tr 
                    data-id="{{.ID}}"
                    data-name="{{.Name}}"
                    data-shirt_number="{{.ShirtNumber}}"
                    data-position="{{.Position}}"
                    data-matches_played="{{.MatchesPlayed}}"
                    data-goals="{{.Goals}}"
                    data-yellow_cards="{{.YellowCards}}"
                    data-red_cards="{{.RedCards}}"
                    data-status="{{.Status}}"
                >
                    <td>{{.Name}}</td>
                    <td>{{.ShirtNumber}}</td>
                    <td>{{.Position}}</td>
                    <td>{{.TeamName}}</td>
                    <td>{{if eq .Status 0}}Active{{else}}Inactive{{end}}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" onclick="showEditModal(this)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </td>
                </tr>
        <!-- Modal for editing player -->
            <div id="editModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4);">
                <div style="background:#fff; max-width:400px; margin:10vh auto; padding:2rem; border-radius:8px; position:relative;">
                    <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h3>
                    <form id="editPlayerForm" onsubmit="return savePlayer(event)">
                        <input type="hidden" name="id" id="edit-id">
                        <div style="margin-bottom:1rem;">
                            <label>‡∏ä‡∏∑‡πà‡∏≠</label>
                            <input type="text" name="name" id="edit-name" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</label>
                            <input type="number" name="shirt_number" id="edit-shirt-number" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <input type="text" name="position" id="edit-position" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô</label>
                            <input type="number" name="matches_played" id="edit-matches-played" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>‡∏õ‡∏£‡∏∞‡∏ï‡∏π</label>
                            <input type="number" name="goals" id="edit-goals" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</label>
                            <input type="number" name="yellow_cards" id="edit-yellow-cards" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>‡πÉ‡∏ö‡πÅ‡∏î‡∏á</label>
                            <input type="number" name="red_cards" id="edit-red-cards" class="form-control" required>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                            <select name="status" id="edit-status" class="form-control">
                                <option value="0">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>
                                <option value="1">‡∏õ‡∏¥‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>
                            </select>
                        </div>
                        <div style="text-align:right;">
                            <button type="button" onclick="closeEditModal()" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            <button type="submit" class="btn btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </form>
                </div>
            </div>
                {{else}}
                <tr><td colspan="6" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</td></tr>
                {{end}}
            </tbody>
        </table>
        <div style="display:flex; justify-content:center; gap:1rem; margin:1rem 0;">
            {{if .HasPrev}}
            <a href="/players.html?page={{.PrevPage}}&page_size={{.PageSize}}{{if .TeamID}}&team_id={{.TeamID}}{{end}}{{if .Name}}&name={{.Name}}{{end}}" class="btn btn-secondary">&laquo; Prev</a>
            {{end}}
            <div style="align-self:center">‡∏´‡∏ô‡πâ‡∏≤ {{.CurrentPage}} / {{.TotalPages}} ({{.TotalCount}})</div>
            {{if .HasNext}}
            <a href="/players.html?page={{.NextPage}}&page_size={{.PageSize}}{{if .TeamID}}&team_id={{.TeamID}}{{end}}{{if .Name}}&name={{.Name}}{{end}}" class="btn btn-secondary">Next &raquo;</a>
            {{end}}
        </div>
    </div>
    <script>
        function scrapePlayers() {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            const btn = document.getElementById('scrapePlayerBtn');
            btn.disabled = true;
            btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á...';
            const baseUrl = window.location.origin;
            fetch(baseUrl + '/scraper/player')
                .then(res => res.text())
                .then(text => {
                    alert('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ' + text);
                    window.location.reload();
                })
                .catch(err => {
                    alert('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.textContent = 'üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
                });
        }
        // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏µ‡∏Å‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°
        let allLeagues = [];
        let allTeams = [];
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/leagues').then(r=>r.json()).then(data => {
                allLeagues = data.data || data.Data || [];
                const leagueSelect = document.getElementById('leagueSelect');
                leagueSelect.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏•‡∏µ‡∏Å --</option>' + allLeagues.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            });
            fetch('/api/teams').then(r=>r.json()).then(data => {
                allTeams = data.data || data.Data || [];
                renderTeamOptions();
            });
            document.getElementById('leagueSelect').addEventListener('change', renderTeamOptions);
        });
        function renderTeamOptions() {
            const leagueId = document.getElementById('leagueSelect').value;
            let teams = allTeams;
            if (leagueId) {
                teams = allTeams.filter(t => t.league_id == leagueId);
            }
            const teamSelect = document.getElementById('teamSelect');
            teamSelect.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡∏° --</option>' + teams.map(t => `<option value="${t.id}">${t.name_th}</option>`).join('');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô filter ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (reload ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ team_id)
        function filterPlayers() {
            const teamId = document.getElementById('teamSelect').value;
            const playerName = document.getElementById('playerNameInput').value.trim();
            let url = '/players.html';
            const params = [];
            if (teamId) params.push('team_id=' + encodeURIComponent(teamId));
            if (playerName) params.push('name=' + encodeURIComponent(playerName));
            if (params.length > 0) url += '?' + params.join('&');
            window.location.href = url;
        }
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        function showEditModal(btn) {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• player ‡∏à‡∏≤‡∏Å data-* ‡∏Ç‡∏≠‡∏á <tr>
            var tr = btn.closest('tr');
            document.getElementById('edit-id').value = tr.getAttribute('data-id');
            document.getElementById('edit-name').value = tr.getAttribute('data-name');
            document.getElementById('edit-shirt-number').value = tr.getAttribute('data-shirt_number');
            document.getElementById('edit-position').value = tr.getAttribute('data-position');
            document.getElementById('edit-matches-played').value = tr.getAttribute('data-matches_played');
            document.getElementById('edit-goals').value = tr.getAttribute('data-goals');
            document.getElementById('edit-yellow-cards').value = tr.getAttribute('data-yellow_cards');
            document.getElementById('edit-red-cards').value = tr.getAttribute('data-red_cards');
            document.getElementById('edit-status').value = tr.getAttribute('data-status');
            document.getElementById('editModal').style.display = 'block';
        }
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        function savePlayer(event) {
            event.preventDefault();
            const form = document.getElementById('editPlayerForm');
            const id = document.getElementById('edit-id').value;
            const payload = {
                name: document.getElementById('edit-name').value,
                shirt_number: parseInt(document.getElementById('edit-shirt-number').value),
                position: document.getElementById('edit-position').value,
                matches_played: parseInt(document.getElementById('edit-matches-played').value),
                goals: parseInt(document.getElementById('edit-goals').value),
                yellow_cards: parseInt(document.getElementById('edit-yellow-cards').value),
                red_cards: parseInt(document.getElementById('edit-red-cards').value),
                status: parseInt(document.getElementById('edit-status').value)
            };
            fetch(`/api/players/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (res.ok) {
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    closeEditModal();
                    location.reload();
                } else {
                    res.text().then(t => alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + t));
                }
            })
            .catch(err => {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err);
            });
            return false;
        }
    </script>
</body>
</html>
