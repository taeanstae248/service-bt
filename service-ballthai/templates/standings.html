<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô | BallThai</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/matches.css">
    <style>
        .standings-table th, .standings-table td { text-align: center; }
        .move-btn { cursor: pointer; padding: 2px 8px; }
        .move-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">‚öΩ BallThai - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
            <div class="user-info">
                <a href="/dashboard.html" style="color: white; text-decoration: none; margin-right: 1rem;">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                <a href="/leagues.html" style="color: white; text-decoration: none; margin-right: 1rem;">üèÜ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏µ‡∏Å</a>
                <a href="/teams.html" style="color: white; text-decoration: none; margin-right: 1rem;">‚öΩ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°</a>
                <a href="/matches.html" style="color: white; text-decoration: none; margin-right: 1rem;">üìÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡∏ó‡∏ä‡πå</a>
                <a href="/standings.html" style="color: white; text-decoration: none; margin-right: 1rem; font-weight: bold;">üìä ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</a>
                <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>
    <div class="container">
        <h1>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h1>
        <div style="margin-bottom:1rem;">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏µ‡∏Å:</label>
            <select id="league_select" class="search-input"></select>
            <button onclick="fetchStandings()" class="btn-primary">üîé ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            <span id="stageZoneContainer" style="margin-left:1rem;"></span>
        </div>
        <div id="standingsContainer"></div>
    </div>
    <script>
    async function fetchLeagues() {
        const res = await fetch('/api/leagues');
        const data = await res.json();
        const select = document.getElementById('league_select');
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏µ‡∏Å --</option>';
        if(data.success) {
            data.data.forEach(l => {
                select.innerHTML += `<option value="${l.id}">${l.name}</option>`;
            });
        }
    }
    async function fetchStandings() {
    const leagueId = document.getElementById('league_select').value;
    if(!leagueId) return;
    const res = await fetch(`/api/standings?league_id=${leagueId}`);
    const data = await res.json();
    if(data.success) renderStandingsTableWithStage(data.data);
    }
    function renderStandingsTable(standings) {
        // ...‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ renderStandingsTableWithStage...
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: render standings ‡∏û‡∏£‡πâ‡∏≠‡∏° dropdown ‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö
    function renderStandingsTableWithStage(standings) {
        // ‡∏´‡∏≤ unique stage_id ‡∏ó‡∏µ‡πà‡∏°‡∏µ stage_name ‡∏à‡∏£‡∏¥‡∏á
        const stages = {};
        standings.forEach(s => {
            if(s.stage_id && s.stage_id.Valid && s.stage_name && typeof s.stage_name === 'string' && s.stage_name.trim() !== '') {
                const id = s.stage_id.Int64;
                if(!stages[id]) stages[id] = s.stage_name.trim();
            }
        });
        const stageIds = Object.keys(stages);
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 stage_id ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á dropdown
        const stageZoneContainer = document.getElementById('stageZoneContainer');
        let selectedStageId = null;
        if(stageIds.length > 1) {
            let html = '<label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö:</label> <select id="stage_select" class="search-input">';
            stageIds.forEach(id => {
                html += `<option value="${id}">${stages[id]}</option>`;
            });
            html += '</select>';
            stageZoneContainer.innerHTML = html;
            selectedStageId = stageIds[0];
            // event: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö
            if(lastStageDropdown) lastStageDropdown.onchange = null;
            const dropdown = document.getElementById('stage_select');
            dropdown.onchange = function() {
                renderStandingsTableWithStage._selectedStageId = this.value;
                renderStandingsTableWithStage._allStandings = standings;
                renderStandingsTableWithStage(standings);
            };
            lastStageDropdown = dropdown;
            // ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
            if(renderStandingsTableWithStage._selectedStageId) {
                selectedStageId = renderStandingsTableWithStage._selectedStageId;
            } else {
                renderStandingsTableWithStage._selectedStageId = selectedStageId;
            }
        } else {
            stageZoneContainer.innerHTML = '';
        }
        // filter ‡∏ï‡∏≤‡∏° stage_id ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        let filtered = standings;
        if(stageIds.length > 1 && renderStandingsTableWithStage._selectedStageId) {
            filtered = standings.filter(s => s.stage_id && s.stage_id.Valid && String(s.stage_id.Int64) === String(renderStandingsTableWithStage._selectedStageId));
        }
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        let html = `<table class="standings-table" border="1" cellpadding="4" style="width:100%;margin-top:1rem;">
            <thead><tr>
                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ó‡∏µ‡∏°</th><th>‡πÅ‡∏Ç‡πà‡∏á</th><th>‡∏ä‡∏ô‡∏∞</th><th>‡πÄ‡∏™‡∏°‡∏≠</th><th>‡πÅ‡∏û‡πâ</th><th>‡πÑ‡∏î‡πâ</th><th>‡πÄ‡∏™‡∏µ‡∏¢</th><th>‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th><th>‡πÅ‡∏ï‡πâ‡∏°</th><th>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr></thead><tbody>`;
        filtered.sort((a,b) => (a.current_rank?.Int64||0)-(b.current_rank?.Int64||0));
        filtered.forEach((s,i) => {
            html += `<tr data-id="${s.id}" data-rank="${s.current_rank?.Int64||i+1}">
                <td>${s.current_rank?.Int64||i+1}</td>
                <td>${(s.team_name && typeof s.team_name === 'string') ? s.team_name : '-'}</td>
                <td>${s.matches_played}</td>
                <td>${s.wins}</td>
                <td>${s.draws}</td>
                <td>${s.losses}</td>
                <td>${s.goals_for}</td>
                <td>${s.goals_against}</td>
                <td>${s.goal_difference}</td>
                <td>${s.points}</td>
                <td>
                    <button class="move-btn" onclick="moveRow(this, -1)" ${i===0?'disabled':''}>‚¨ÜÔ∏è</button>
                    <button class="move-btn" onclick="moveRow(this, 1)" ${i===filtered.length-1?'disabled':''}>‚¨áÔ∏è</button>
                </td>
                <td><button onclick="editStanding(${s.id})">‚úèÔ∏è</button></td>
            </tr>`;
        });
        html += '</tbody></table>';
        html += '<button class="btn-primary" onclick="saveOrder()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</button>';
        document.getElementById('standingsContainer').innerHTML = html;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: render standings ‡∏û‡∏£‡πâ‡∏≠‡∏° dropdown ‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö
    let lastStageDropdown = null;
    function renderStandingsTableWithStage(standings) {
        // ‡∏´‡∏≤ unique stage_id ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const stages = {};
        standings.forEach(s => {
            if(s.stage_id && s.stage_id.Valid) {
                const id = s.stage_id.Int64;
                // ‡πÉ‡∏ä‡πâ stage_name ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å record ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠ id ‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ä‡πâ '‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö {id}'
                if(!stages[id]) stages[id] = (s.stage_name && typeof s.stage_name === 'string') ? s.stage_name : `‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö ${id}`;
            }
        });
        const stageIds = Object.keys(stages);
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 stage_id ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á dropdown
        const stageZoneContainer = document.getElementById('stageZoneContainer');
        let selectedStageId = null;
        if(stageIds.length > 1) {
            let html = '<label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö:</label> <select id="stage_select" class="search-input">';
            stageIds.forEach(id => {
                html += `<option value="${id}">${stages[id]}</option>`;
            });
            html += '</select>';
            stageZoneContainer.innerHTML = html;
            selectedStageId = stageIds[0];
            // event: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö
            if(lastStageDropdown) lastStageDropdown.onchange = null;
            const dropdown = document.getElementById('stage_select');
            dropdown.onchange = function() {
                renderStandingsTableWithStage._selectedStageId = this.value;
                renderStandingsTableWithStage._allStandings = standings;
                renderStandingsTableWithStage(standings);
            };
            lastStageDropdown = dropdown;
            // ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
            if(renderStandingsTableWithStage._selectedStageId) {
                selectedStageId = renderStandingsTableWithStage._selectedStageId;
            } else {
                renderStandingsTableWithStage._selectedStageId = selectedStageId;
            }
        } else {
            stageZoneContainer.innerHTML = '';
        }
        // filter ‡∏ï‡∏≤‡∏° stage_id ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        let filtered = standings;
        if(stageIds.length > 1 && renderStandingsTableWithStage._selectedStageId) {
            filtered = standings.filter(s => s.stage_id && s.stage_id.Valid && String(s.stage_id.Int64) === String(renderStandingsTableWithStage._selectedStageId));
        }
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
        let html = `<table class="standings-table" border="1" cellpadding="4" style="width:100%;margin-top:1rem;">
            <thead><tr>
                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ó‡∏µ‡∏°</th><th>‡πÅ‡∏Ç‡πà‡∏á</th><th>‡∏ä‡∏ô‡∏∞</th><th>‡πÄ‡∏™‡∏°‡∏≠</th><th>‡πÅ‡∏û‡πâ</th><th>‡πÑ‡∏î‡πâ</th><th>‡πÄ‡∏™‡∏µ‡∏¢</th><th>‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th><th>‡πÅ‡∏ï‡πâ‡∏°</th><th>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr></thead><tbody>`;
        filtered.sort((a,b) => (a.current_rank?.Int64||0)-(b.current_rank?.Int64||0));
        filtered.forEach((s,i) => {
            html += `<tr data-id="${s.id}" data-rank="${s.current_rank?.Int64||i+1}">
                <td>${s.current_rank?.Int64||i+1}</td>
                <td>${(s.team_name && typeof s.team_name === 'string') ? s.team_name : '-'}</td>
                <td>${s.matches_played}</td>
                <td>${s.wins}</td>
                <td>${s.draws}</td>
                <td>${s.losses}</td>
                <td>${s.goals_for}</td>
                <td>${s.goals_against}</td>
                <td>${s.goal_difference}</td>
                <td>${s.points}</td>
                <td>
                    <button class="move-btn" onclick="moveRow(this, -1)" ${i===0?'disabled':''}>‚¨ÜÔ∏è</button>
                    <button class="move-btn" onclick="moveRow(this, 1)" ${i===filtered.length-1?'disabled':''}>‚¨áÔ∏è</button>
                </td>
                <td><button onclick="editStanding(${s.id})">‚úèÔ∏è</button></td>
            </tr>`;
        });
        html += '</tbody></table>';
        html += '<button class="btn-primary" onclick="saveOrder()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</button>';
        document.getElementById('standingsContainer').innerHTML = html;
    }
    function moveRow(btn, dir) {
        const row = btn.closest('tr');
        const tbody = row.parentNode;
        const idx = Array.from(tbody.children).indexOf(row);
        if((dir === -1 && idx === 0) || (dir === 1 && idx === tbody.children.length-1)) return;
        if(dir === -1) tbody.insertBefore(row, tbody.children[idx-1]);
        else tbody.insertBefore(row.nextSibling, row);
        updateMoveBtnState(tbody);
    }
    function updateMoveBtnState(tbody) {
        Array.from(tbody.children).forEach((row,i,arr) => {
            row.querySelectorAll('.move-btn')[0].disabled = i===0;
            row.querySelectorAll('.move-btn')[1].disabled = i===arr.length-1;
        });
    }
    async function saveOrder() {
        const leagueId = document.getElementById('league_select').value;
        const rows = document.querySelectorAll('.standings-table tbody tr');
        const order = Array.from(rows).map((row,i) => ({ id: row.dataset.id, current_rank: i+1 }));
        // TODO: ‡∏™‡πà‡∏á order ‡∏ô‡∏µ‡πâ‡πÑ‡∏õ backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö (mock): '+JSON.stringify(order));
    }
    function editStanding(id) {
        alert('‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (mock) id='+id);
    }
    fetchLeagues();
    </script>
</body>
</html>
