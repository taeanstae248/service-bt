<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô | BallThai</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/matches.css">
    <style>
        .standings-table th, .standings-table td { text-align: center; }
        .move-btn { cursor: pointer; padding: 2px 8px; }
        .move-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">‚öΩ BallThai - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£sss‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô++</div>
            <div class="user-info">
                <a href="/dashboard.html" style="color: white; text-decoration: none; margin-right: 1rem;">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
                <a href="/leagues.html" style="color: white; text-decoration: none; margin-right: 1rem;">üèÜ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏µ‡∏Å</a>
                <a href="/teams.html" style="color: white; text-decoration: none; margin-right: 1rem;">‚öΩ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°</a>
                <a href="/matches.html" style="color: white; text-decoration: none; margin-right: 1rem;">üìÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡∏ó‡∏ä‡πå</a>
                <a href="/standings.html" style="color: white; text-decoration: none; margin-right: 1rem; font-weight: bold;">üìä ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</a>
                <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>
    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏Ç‡∏≠‡∏á body ‡πÄ‡∏ä‡πà‡∏ô container standings, league_select, stageZoneContainer, standingsContainer -->
    <div id="mainContainer">
        <div style="margin-bottom:1rem">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏µ‡∏Å:</label>
            <select id="league_select" class="search-input"></select>
        </div>
        <div id="stageZoneContainer"></div>
        <div id="standingsContainer"></div>
    </div>
    <script>
    console.log('DEBUG: JS loaded and running!');
    window._debugLog = [];
    function debugLog(msg) {
        window._debugLog.push(msg);
        try { console.log(msg); } catch(e) {}
        try { alert(msg); } catch(e) {}
    }
    async function renderStandingsTableWithStage(standings, stagesData) {
        // DEBUG: log mapping
        let stagesMap = {};
        window._debugStagesMap = stagesMap;
        window._debugStandings = standings;
        // DEBUG: log id ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô standings ‡∏Å‡πà‡∏≠‡∏ô fetch stages
        console.log('DEBUG: standings stage_id', standings.map(s => s.stage_id?.Int64));
        // ‡πÉ‡∏ä‡πâ stagesData ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å API
        if (Array.isArray(stagesData)) {
            stagesData.forEach(s => {
                stagesMap[String(s.id)] = s.stage_name;
            });
        }
        // map stage_id ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô standings -> stage_name (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç id ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)
        const stages = {};
        if (!standings || !Array.isArray(standings)) {
            console.error('standings ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:', standings);
            return;
        }
        standings.forEach(s => {
            if(s.stage_id && s.stage_id.Valid) {
                const idStr = String(s.stage_id.Int64);
                // map id ‡πÄ‡∏õ‡πá‡∏ô string ‡πÄ‡∏™‡∏°‡∏≠
                let stageName = stagesMap[idStr];
                if(!stages[idStr]) stages[idStr] = stageName || idStr;
            }
        });
        const stageIds = Object.keys(stages);
        // DEBUG: log mapping
        console.log('stagesMap', stagesMap);
        console.log('stages', stages);
        console.log('stageIds', stageIds);
        // render dropdown
        const stageZoneContainer = document.getElementById('stageZoneContainer');
        let selectedStageId = null;
        if(stageIds.length > 1) {
            let html = '<label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö:</label> <select id="stage_select" class="search-input">';
            stageIds.forEach(id => {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å stagesMap ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏™‡∏î‡∏á "‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö id"
                let stageName = stagesMap[String(id)] || `‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö ${id}`;
                html += `<option value="${id}">${stageName}</option>`;
            });
            html += '</select>';
            stageZoneContainer.innerHTML = html;
            selectedStageId = stageIds[0];
            if(window.lastStageDropdown) window.lastStageDropdown.onchange = null;
            const dropdown = document.getElementById('stage_select');
            dropdown.onchange = function() {
                console.log('DEBUG: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô/‡∏£‡∏≠‡∏ö', this.value, '->', stagesMap[String(this.value)]);
                renderStandingsTableWithStage._selectedStageId = this.value;
                renderStandingsTableWithStage._allStandings = standings;
                renderStandingsTableWithStage(standings);
            };
            window.lastStageDropdown = dropdown;
            if(renderStandingsTableWithStage._selectedStageId) {
                selectedStageId = renderStandingsTableWithStage._selectedStageId;
            } else {
                renderStandingsTableWithStage._selectedStageId = selectedStageId;
            }
        } else {
            stageZoneContainer.innerHTML = '';
        }
        // filter ‡∏ï‡∏≤‡∏° stage_id
        let filtered = standings;
        if(stageIds.length > 1 && renderStandingsTableWithStage._selectedStageId) {
            filtered = standings.filter(s => s.stage_id && s.stage_id.Valid && String(s.stage_id.Int64) === String(renderStandingsTableWithStage._selectedStageId));
        }
        // render table
        let html = `<table class="standings-table" border="1" cellpadding="4" style="width:100%;margin-top:1rem;">
            <thead><tr>
                <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ó‡∏µ‡∏°</th><th>‡πÅ‡∏Ç‡πà‡∏á</th><th>‡∏ä‡∏ô‡∏∞</th><th>‡πÄ‡∏™‡∏°‡∏≠</th><th>‡πÅ‡∏û‡πâ</th><th>‡πÑ‡∏î‡πâ</th><th>‡πÄ‡∏™‡∏µ‡∏¢</th><th>‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th><th>‡πÅ‡∏ï‡πâ‡∏°</th><th>‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr></thead><tbody>`;
        filtered.sort((a,b) => (a.current_rank?.Int64||0)-(b.current_rank?.Int64||0));
        filtered.forEach((s,i) => {
            html += `<tr data-id="${s.id}" data-rank="${s.current_rank?.Int64||i+1}">
                <td>${s.current_rank?.Int64||i+1}</td>
                <td>${(s.team_name && typeof s.team_name === 'string') ? s.team_name : '-'}</td>
                <td>${s.matches_played}</td>
                <td>${s.wins}</td>
                <td>${s.draws}</td>
                <td>${s.losses}</td>
                <td>${s.goals_for}</td>
                <td>${s.goals_against}</td>
                <td>${s.goal_difference}</td>
                <td>${s.points}</td>
                <td>
                    <button class="move-btn" onclick="moveRow(this, -1)" ${i===0?'disabled':''}>‚¨ÜÔ∏è</button>
                    <button class="move-btn" onclick="moveRow(this, 1)" ${i===filtered.length-1?'disabled':''}>‚¨áÔ∏è</button>
                </td>
                <td><button onclick="editStanding(${s.id})">‚úèÔ∏è</button></td>
            </tr>`;
        });
        html += '</tbody></table>';
        html += '<button class="btn-primary" onclick="saveOrder()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</button>';
        document.getElementById('standingsContainer').innerHTML = html;
    }
    function moveRow(btn, dir) {
        const row = btn.closest('tr');
        const tbody = row.parentNode;
        const idx = Array.from(tbody.children).indexOf(row);
        if((dir === -1 && idx === 0) || (dir === 1 && idx === tbody.children.length-1)) return;
        if(dir === -1) tbody.insertBefore(row, tbody.children[idx-1]);
        else tbody.insertBefore(row.nextSibling, row);
        updateMoveBtnState(tbody);
    }
    function updateMoveBtnState(tbody) {
        Array.from(tbody.children).forEach((row,i,arr) => {
            row.querySelectorAll('.move-btn')[0].disabled = i===0;
            row.querySelectorAll('.move-btn')[1].disabled = i===arr.length-1;
        });
    }
    async function saveOrder() {
        const leagueId = document.getElementById('league_select')?.value;
        const rows = document.querySelectorAll('.standings-table tbody tr');
        const order = Array.from(rows).map((row,i) => ({ id: row.dataset.id, current_rank: i+1 }));
        // TODO: ‡∏™‡πà‡∏á order ‡∏ô‡∏µ‡πâ‡πÑ‡∏õ backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö (mock): '+JSON.stringify(order));
    }
    function editStanding(id) {
        alert('‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (mock) id='+id);
    }
    // TODO: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fetchLeagues() ‡πÅ‡∏•‡∏∞ render ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
    // DEBUG: mock data ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderStandingsTableWithStage ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
    document.addEventListener('DOMContentLoaded', function() {
    debugLog('DEBUG: DOMContentLoaded event fired!');
        // ‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏µ‡∏Å‡πÅ‡∏•‡∏∞ stages ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API
    debugLog('DEBUG: ‡πÄ‡∏£‡∏¥‡πà‡∏° fetch /api/stages ...');
        fetch('/api/stages')
            .then(res => {
                debugLog('DEBUG: fetch /api/stages response status: ' + res.status);
                if (!res.ok) throw new Error('HTTP error ' + res.status);
                return res.json();
            })
            .then(data => {
                debugLog('DEBUG: /api/stages data: ' + JSON.stringify(data));
                if (data.success && Array.isArray(data.data)) {
                    // ‡πÄ‡∏ï‡∏¥‡∏° dropdown league_select ‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏µ‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô stages
                    const leagueSelect = document.getElementById('league_select');
                    const leagues = {};
                    data.data.forEach(s => { if (s.league_id) leagues[s.league_id] = true; });
                    leagueSelect.innerHTML = Object.keys(leagues).map(lid => `<option value="${lid}">‡∏•‡∏µ‡∏Å ${lid}</option>`).join('');
                    // mock standings (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô fetch ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á)
                    const standings = [
                        {id: 1, team_name: '‡∏ó‡∏µ‡∏° A', matches_played: 10, wins: 6, draws: 2, losses: 2, goals_for: 20, goals_against: 10, goal_difference: 10, points: 20, current_rank: {Int64: 1}, stage_id: {Int64: 1, Valid: true}},
                        {id: 2, team_name: '‡∏ó‡∏µ‡∏° B', matches_played: 10, wins: 5, draws: 3, losses: 2, goals_for: 18, goals_against: 12, goal_difference: 6, points: 18, current_rank: {Int64: 2}, stage_id: {Int64: 1, Valid: true}},
                        {id: 3, team_name: '‡∏ó‡∏µ‡∏° C', matches_played: 10, wins: 4, draws: 4, losses: 2, goals_for: 15, goals_against: 13, goal_difference: 2, points: 16, current_rank: {Int64: 3}, stage_id: {Int64: 2, Valid: true}}
                    ];
                    renderStandingsTableWithStage(standings, data.data);
                } else {
                    debugLog('API /api/stages ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ' + JSON.stringify(data));
                }
            })
            .catch(err => {
                debugLog('fetch /api/stages error: ' + err);
            });
    });
    </script>
</body>
</body>
<script>
alert('DEBUG: <script> at end of body executed!');
console.log('DEBUG: <script> at end of body executed!');
</script>
</html>
